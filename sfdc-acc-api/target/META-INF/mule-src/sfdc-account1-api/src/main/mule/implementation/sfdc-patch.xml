<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:salesforce="http://www.mulesoft.org/schema/mule/salesforce"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/salesforce http://www.mulesoft.org/schema/mule/salesforce/current/mule-salesforce.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<sub-flow name="sfdc-patch-subflow" doc:id="bfa3b5b0-3ad9-40dc-8dd3-fdf200ad740a" >
		<until-successful maxRetries="${retry.count}" doc:name="retry" doc:id="fcd92d5c-ae52-4dbb-8734-488349361a38" millisBetweenRetries="${retry.interval}">
			<try doc:name="Try" doc:id="7549d662-770c-47b8-88cb-9f617056b92c" >
				<ee:transform doc:name="Transform Message" doc:id="e782c486-5cd0-4abf-bc8b-1a6dc2c9bad5">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json skipNullOn="everywhere"
---
payload map{
	"Id": $.id,
	"Name": $.name,
	"Phone": $.phoneNumber,
	"EMAIL__c": $.emailAddress,
	"ShippingAddress": $.shippingAddress,
	"ShippingCity": $.shippingCity,
	"ShippingCountry": $.shippingCountry,
	"ShippingPostalCode": $.shippingPostalCode,
	"ShippingState": $.shippingState,
	"Active__c": $.active as String,
	"ExternalAccountid__c": $.externalAccountId
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
				<salesforce:upsert doc:name="Upsert" doc:id="4112b80e-277f-4730-aac2-49d75fca423f" config-ref="Salesforce_Config" objectType="Account" externalIdFieldName="ExternalAccountid__c" />
				<ee:transform doc:name="Transform Message" doc:id="a8e5a2cc-2062-4e99-86a3-c1c354c809d6">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
payload]]></ee:set-payload>
			</ee:message>
		</ee:transform>
				<logger level="INFO" doc:name="Logger" doc:id="62cedc00-a313-4a96-bfcb-8919fcc43b79" message="#[payload]" category="salesforceresponse"/>
				<ee:transform doc:name="Transform Message" doc:id="7acb2942-40cb-40b0-ac2b-c6166bb2614b" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload.items map{
	"id": $.id,
	"success": $.successful,
	"error": $.message default ""
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
				<error-handler >
					<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="673d7797-397f-4947-8e08-3c24e550190c" type="SALESFORCE:CONNECTIVITY, SALESFORCE:TIMEOUT">
						<logger level="INFO" doc:name="Logger" doc:id="d6f55c07-e228-45de-92b6-a537de5ef7af" message="#[error]"/>
					</on-error-propagate>
					<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="a557d04d-3ffa-4337-9f2d-e8cdc4e5c464" >
						<logger level="INFO" doc:name="Logger" doc:id="5307097f-baec-4a81-bfad-68e8c880cb87" message="#[error]"/>
						<set-variable value="#[error]" doc:name="Set Variable" doc:id="0902d090-e7ee-4ce3-ab66-69ad997dc31f" variableName="processingError"/>
					</on-error-continue>
				</error-handler>
			</try>
			<choice doc:name="Choice" doc:id="61efa04e-d842-4165-af3a-de17f15b4245" >
				<when expression="#[!(isEmpty(vars.processingError))]">
					<ee:transform doc:name="Transform Message" doc:id="25bacece-435a-460a-8781-0cb27d73eadb">
						<ee:message>
							<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
	"status" : "failed",
	"error" : vars.processingError
}]]></ee:set-payload>
						</ee:message>
					</ee:transform>
					<raise-error doc:name="Raise error" doc:id="88b3b06a-f407-4bfb-8e7f-5fcb8192eee5" type="SFDC:ONERRORCONTINUEERROR" description='"record processing failed"'/>
				</when>
				<otherwise >
					<logger level="INFO" doc:name="Logger" doc:id="7a3d4810-8974-49d5-a132-fce807374cc2" message='#["Successfully Created/Updated in Salesforce"]'/>
				</otherwise>
			</choice>
		</until-successful>
	</sub-flow>
</mule>
